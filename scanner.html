<script>
  // âœ… í•„ìš”í•œ ì •ë³´ ì…ë ¥
  const MONTH = "7";
  const DAY = "24";
  const BUYER = "MMJ";

  const SCAN_URL_BASE = `https://script.google.com/macros/s/AKfycbxaZSp4pi62sROhqhyDcRzFpBspjZWhCL9HDr7xx8Jb7lovTUKxj8h9ED2kWMnU-PEfVw/exec`;

  let qrScanner;

  function startScanner() {
    qrScanner = new Html5Qrcode("reader");

    const boxWidth = Math.floor(window.innerWidth * 0.9);
    const boxHeight = Math.floor(boxWidth * 0.25);

    qrScanner.start(
      { facingMode: { exact: "environment" } },
      {
        fps: 15,
        qrbox: { width: boxWidth, height: boxHeight }
      },
      code => {
        qrScanner.stop().then(() => {
          handleScan(code);
        });
      }
    ).catch(err => {
      const fb = document.getElementById("feedback");
      fb.innerHTML = "âŒ\n\nCamera Access Error\n\n" + err;
      fb.style.color = "red";
    });
  }

  function handleScan(code) {
    const feedback = document.getElementById("feedback");
    const nextButton = document.getElementById("nextButton");

    // âœ… íŒŒë¼ë¯¸í„° í¬í•¨ ìš”ì²­
    const url = `${SCAN_URL_BASE}?code=${encodeURIComponent(code)}&month=${MONTH}&day=${DAY}&buyer=${BUYER}`;

    fetch(url)
      .then(res => res.text())
      .then(result => {
        const parts = result.split(":");
        const status = parts[0];
        const row = parts[1] || "";
        const sscc = parts[2] || "";
        const carton = parts[3] || "";
        const scanned = parts[4] || "";
        const total = parts[5] || "";

        if (status === "âœ“") {
          feedback.innerHTML =
            `âœ…\n\nSSCC: ${sscc}\n\nCarton: ${carton}\n\nRow: ${row}\n\nLoading Status: ${scanned} / ${total}`;
          feedback.style.color = "lime";
        } else if (status === "DUP") {
          feedback.innerHTML =
            `ğŸ” DUP\n\nSSCC: ${sscc}\n\nCarton: ${carton}\n\nRow: ${row}\n\nLoading Status: ${scanned} / ${total}`;
          feedback.style.color = "orange";
        } else {
          feedback.innerHTML = "âŒ\n\nNot Registered";
          feedback.style.color = "red";
        }

        nextButton.style.display = "block";
      })
      .catch(() => {
        feedback.innerHTML = "âŒ\n\nServer Error";
        feedback.style.color = "red";
        nextButton.style.display = "block";
      });
  }

  function restartScanner() {
    const feedback = document.getElementById("feedback");
    const nextButton = document.getElementById("nextButton");
    feedback.innerHTML = "";
    nextButton.style.display = "none";
    startScanner();
  }

  window.addEventListener("DOMContentLoaded", () => {
    startScanner();
  });
</script>
