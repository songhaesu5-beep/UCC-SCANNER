<script>
  const SCAN_URL_BASE = "https://script.google.com/macros/s/AKfycbxAPI3xgaD7q-1okrdglubNIYb2G6uMmRJfF8HvcusJvOMv-3339LpzWLF0KvzG34rMDg/exec?code=";

  let qrScanner;

  function startScanner() {
    qrScanner = new Html5Qrcode("reader");

    const boxWidth = Math.floor(window.innerWidth * 0.9);
    const boxHeight = Math.floor(boxWidth * 0.3);

    qrScanner.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: boxWidth, height: boxHeight }
      },
      code => {
        qrScanner.stop().then(() => {
          handleScan(code);
        });
      }
    ).catch(err => {
      const fb = document.getElementById("feedback");
      fb.innerHTML = "âŒ<br>Camera Access Error<br>" + err;
      fb.style.color = "red";
    });
  }

  function handleScan(code) {
    const feedback = document.getElementById("feedback");
    const nextButton = document.getElementById("nextButton");

    fetch(SCAN_URL_BASE + encodeURIComponent(code))
      .then(res => res.text())
      .then(result => {
        const parts = result.split(":");
        const status = parts[0];
        const row = parts[1] || "";
        const sscc = parts[2] || "";
        const carton = parts[3] || "";
        const scanned = parts[4] || "";
        const total = parts[5] || "";

        if (status === "âœ“") {
          feedback.innerHTML = `âœ…<br><br>SSCC: ${sscc}<br><br>Carton: ${carton}<br><br>Row: ${row}<br><br>Loading Status: ${scanned} / ${total}`;
          feedback.style.color = "lime";
        } else if (status === "DUP") {
          feedback.innerHTML = `ğŸ” DUP<br><br>SSCC: ${sscc}<br><br>Carton: ${carton}<br><br>Row: ${row}<br><br>Loading Status: ${scanned} / ${total}`;
          feedback.style.color = "orange";
        } else {
          feedback.innerHTML = "âŒ<br><br>Not Registered";
          feedback.style.color = "red";
        }

        nextButton.style.display = "block";
      })
      .catch(() => {
        feedback.innerHTML = "âŒ<br><br>Server Error";
        feedback.style.color = "red";
        nextButton.style.display = "block";
      });
  }

  function restartScanner() {
    const feedback = document.getElementById("feedback");
    const nextButton = document.getElementById("nextButton");
    feedback.innerHTML = "";
    nextButton.style.display = "none";
    startScanner();
  }

  window.addEventListener("DOMContentLoaded", () => {
    startScanner();
  });
</script>
