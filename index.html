<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>UCC Scanner</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.9/html5-qrcode.min.js"></script>
  <style>
    #reader {
      width: 100%;
      height: 400px;
      border: 2px dashed #999;
      margin: auto;
    }
    #feedback {
      font-size: 5em;
      text-align: center;
      margin-top: 30px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="reader"></div>
<div id="feedback"></div>

<script>
const SCAN_URL_BASE = "https://script.google.com/macros/s/AKfycby47A__5YeAq6n04cBzJH_yaFdl4WB96Bqyp5Hg_YDk4shALnFdPlQOmvyk65X_My2kiA/exec?code=";

let html5QrcodeScanner;

function startScanner() {
  html5QrcodeScanner = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(devices => {
    if (devices && devices.length) {
      html5QrcodeScanner.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 600, height: 200 },
        },
        onScanSuccess,
        onScanFailure
      );
    } else {
      document.getElementById("feedback").innerText = "âŒ ì¹´ë©”ë¼ ì—†ìŒ";
    }
  }).catch(err => {
    console.error("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:", err);
    document.getElementById("feedback").innerText = "âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨";
  });
}

function onScanSuccess(code) {
  html5QrcodeScanner.stop().then(() => {
    handleScan(code);
  });
}

function onScanFailure(error) {
  // ë¬´ì‹œ (ì½˜ì†”ì—ë§Œ ì¶œë ¥)
}

function handleScan(code) {
  fetch(SCAN_URL_BASE + encodeURIComponent(code))
    .then(res => res.text())
    .then(result => {
      const feedback = document.getElementById("feedback");
      if (result.includes("âœ“")) {
        feedback.innerHTML = "âœ…";
        feedback.style.color = "green";
      } else if (result.includes("DUP")) {
        feedback.innerHTML = "ðŸ” DUP";
        feedback.style.color = "orange";
      } else {
        feedback.innerHTML = "âŒ";
        feedback.style.color = "red";
      }

      setTimeout(() => {
        feedback.innerHTML = "";
        startScanner();
      }, 1500);
    })
    .catch(() => {
      document.getElementById("feedback").innerHTML = "âŒ ERROR";
      setTimeout(() => {
        document.getElementById("feedback").innerHTML = "";
        startScanner();
      }, 1500);
    });
}

startScanner();
</script>

</body>
</html>
