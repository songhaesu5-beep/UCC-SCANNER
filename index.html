<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>UCC Scanner</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.9/html5-qrcode.min.js"></script>
  <style>
    #reader {
      width: 100%;
      height: auto;
      margin: auto;
      border: 2px dashed #999;
    }
    #feedback {
      font-size: 5em;
      text-align: center;
      margin-top: 30px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="reader"></div>
<div id="feedback"></div>

<script>
const SCAN_URL_BASE = "https://script.google.com/macros/s/AKfycby47A__5YeAq6n04cBzJH_yaFdl4WB96Bqyp5Hg_YDk4shALnFdPlQOmvyk65X_My2kiA/exec?code=";

function getConfig() {
  return {
    fps: 10,
    qrbox: { width: 600, height: 200 },
    aspectRatio: 16 / 9,
    videoConstraints: {
      facingMode: "environment",
      width: { ideal: 1280 },
      height: { ideal: 720 }
    }
  };
}

function startScanner() {
  const qrCodeScanner = new Html5Qrcode("reader");
  qrCodeScanner.start(
    getConfig().videoConstraints,
    getConfig(),
    (code) => {
      qrCodeScanner.stop().then(() => {
        handleScan(code, qrCodeScanner);
      });
    },
    (error) => {}
  );
}

function handleScan(code, qrCodeScanner) {
  fetch(SCAN_URL_BASE + encodeURIComponent(code))
    .then(response => response.text())
    .then(result => {
      const feedback = document.getElementById("feedback");
      if (result.includes("âœ“")) {
        feedback.innerHTML = "âœ…";
        feedback.style.color = "green";
      } else if (result.includes("DUP")) {
        feedback.innerHTML = "ðŸ” DUP";
        feedback.style.color = "orange";
      } else {
        feedback.innerHTML = "âŒ";
        feedback.style.color = "red";
      }

      setTimeout(() => {
        feedback.innerHTML = "";
        qrCodeScanner.start(
          getConfig().videoConstraints,
          getConfig(),
          (newCode) => {
            qrCodeScanner.stop().then(() => {
              handleScan(newCode, qrCodeScanner);
            });
          }
        );
      }, 1500);
    })
    .catch(() => {
      const feedback = document.getElementById("feedback");
      feedback.innerHTML = "âŒ ERROR";
      feedback.style.color = "red";
      setTimeout(() => {
        feedback.innerHTML = "";
        qrCodeScanner.start(
          getConfig().videoConstraints,
          getConfig(),
          (newCode) => {
            qrCodeScanner.stop().then(() => {
              handleScan(newCode, qrCodeScanner);
            });
          }
        );
      }, 1500);
    });
}

startScanner();
</script>

</body>
</html>
